groups:
  - name: opu-api-alerts
    rules:

      # 1) ì¸ìŠ¤í„´ìŠ¤ DOWN (ìŠ¤í¬ë© ìì²´ê°€ ì•ˆë¨)
      - alert: OpuApiDown
        expr: up{job="opu-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ğŸš¨ OPU API DOWN"
          description: "Prometheusê°€ opu-api íƒ€ê²Ÿì„ ìŠ¤í¬ë©í•˜ì§€ ëª»í•©ë‹ˆë‹¤. (up=0, 1m ì§€ì†)"

      # 2) 5xx ì—ëŸ¬ ë¹„ìœ¨ (ìš”ì²­ì´ ê±°ì˜ ì—†ì„ ë•Œ ì˜¤íƒ ë°©ì§€ ìœ„í•´ req rate ì¡°ê±´ ì¶”ê°€)
      - alert: High5xxErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{job="opu-api", status=~"5.."}[5m]))
            /
            clamp_min(sum(rate(http_server_requests_seconds_count{job="opu-api"}[5m])), 1)
          ) > 0.05
          and
          sum(rate(http_server_requests_seconds_count{job="opu-api"}[5m])) > 0.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ğŸš¨ 5xx ì—ëŸ¬ ë¹„ìœ¨ ì¦ê°€"
          description: "ìµœê·¼ 5ë¶„ 5xx ë¹„ìœ¨ì´ 5% ì´ˆê³¼ì´ë©° íŠ¸ë˜í”½ë„ ì¡´ì¬í•©ë‹ˆë‹¤."

      # 3) 4xx ë¹„ìœ¨ ê¸‰ì¦(í´ë¼ì´ì–¸íŠ¸/ì¸ì¦/ê¶Œí•œ ì´ìŠˆ ê°ì§€) - í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ
      - alert: High4xxErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{job="opu-api", status=~"4.."}[10m]))
            /
            clamp_min(sum(rate(http_server_requests_seconds_count{job="opu-api"}[10m])), 1)
          ) > 0.30
          and
          sum(rate(http_server_requests_seconds_count{job="opu-api"}[10m])) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ 4xx ë¹„ìœ¨ ì¦ê°€"
          description: "ìµœê·¼ 10ë¶„ 4xx ë¹„ìœ¨ì´ 30% ì´ˆê³¼ì…ë‹ˆë‹¤(ì¸ì¦/ê¶Œí•œ/ìš”ì²­ í¬ë§· ë³€í™” ê°€ëŠ¥)."

      # 4) ì‘ë‹µ ì§€ì—° p95 (íˆìŠ¤í† ê·¸ë¨ bucket ê¸°ë°˜)
      - alert: HighLatencyP95
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (rate(http_server_requests_seconds_bucket{job="opu-api"}[5m]))
          ) > 1.0
          and
          sum(rate(http_server_requests_seconds_count{job="opu-api"}[5m])) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ ì‘ë‹µ ì§€ì—°(p95) ì¦ê°€"
          description: "ìµœê·¼ 10ë¶„ p95 ì‘ë‹µì‹œê°„ì´ 1.0s ì´ˆê³¼ì…ë‹ˆë‹¤."

      # 5) JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  (Heap ì¤‘ì‹¬ìœ¼ë¡œ ë³´ê³  ì‹¶ìœ¼ë©´ area=\"heap\"ë§Œ ì‚¬ìš©)
      - alert: HighJvmMemoryUsage
        expr: |
          (
            sum(jvm_memory_used_bytes{job="opu-api", area="heap"})
            /
            clamp_min(sum(jvm_memory_max_bytes{job="opu-api", area="heap"}), 1)
          ) > 0.85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ JVM Heap ë©”ëª¨ë¦¬ ë†’ìŒ"
          description: "JVM heap ì‚¬ìš©ë¥ ì´ 85% ì´ˆê³¼ ìƒíƒœê°€ 10ë¶„ ì§€ì†ë©ë‹ˆë‹¤."

      # 6) GC ë©ˆì¶¤ ì‹œê°„ ì¦ê°€(Stop-the-world ëŠë‚Œ ì¡ê¸°)
      - alert: HighGcPause
        expr: |
          rate(jvm_gc_pause_seconds_sum{job="opu-api"}[5m]) > 0.3
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ GC Pause ì¦ê°€"
          description: "GC pause time/secê°€ 0.3s/s ì´ˆê³¼ ìƒíƒœê°€ 10ë¶„ ì§€ì†ë©ë‹ˆë‹¤."

      # 7) DB ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ìœ„í—˜ (Hikari)
      - alert: DbPoolAlmostExhausted
        expr: |
          (
            max(hikaricp_connections_active{job="opu-api"})
            /
            clamp_min(max(hikaricp_connections_max{job="opu-api"}), 1)
          ) > 0.90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ğŸš¨ DB ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ìœ„í—˜"
          description: "Hikari active/maxê°€ 90% ì´ˆê³¼ ìƒíƒœê°€ 5ë¶„ ì§€ì†ë©ë‹ˆë‹¤."

      # 8) ìŠ¤ë ˆë“œ í­ì¦(ë°ë“œë½/ë¸”ë¡œí‚¹/ìŠ¤ë ˆë“œ ëˆ„ìˆ˜ ì¡°ì§)
      - alert: HighJvmThreads
        expr: jvm_threads_live_threads{job="opu-api"} > 300
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ JVM live thread ì¦ê°€"
          description: "live threadsê°€ 300 ì´ˆê³¼ ìƒíƒœê°€ 10ë¶„ ì§€ì†ë©ë‹ˆë‹¤."

      # ---- í…ŒìŠ¤íŠ¸ìš©ì€ í•„ìš”í•  ë•Œë§Œ ì ê¹ ì¼œê¸° ----
      # - alert: TestAlwaysFiring
      #   expr: vector(1)
      #   for: 10s
      #   labels:
      #     severity: test
      #   annotations:
      #     summary: "ğŸ§ª test"
      #     description: "ì—°ë™ í…ŒìŠ¤íŠ¸ìš©"